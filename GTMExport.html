<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GTM JSON → Excel/CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; script-src 'self' https://cdn.jsdelivr.net 'sha256-f4bP6k3KQ6n1zXx4H7qk1u0AiJcG0mT8H9H2yq6a9UQ=' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin: 24px; color:#1f2937; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .card { border:1px solid #e5e7eb; border-radius:8px; padding:16px; max-width:1000px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 280px; min-width:280px; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    input[type="file"] { width:100%; }
    .opts { display:flex; gap:16px; flex-wrap:wrap; margin:8px 0 12px; }
    .opt { display:flex; align-items:center; gap:8px; }
    button { background:#111827; color:#fff; border:0; padding:10px 14px; border-radius:6px; cursor:pointer; }
    button.secondary { background:#374151; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .log { background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; max-height:200px; overflow:auto; }
    .help { color:#4b5563; font-size:13px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" integrity="sha256-f4bP6k3KQ6n1zXx4H7qk1u0AiJcG0mT8H9H2yq6a9UQ=" crossorigin="anonymous"></script>
</head>
<body>
  <h1>GTM Container JSON → Excel/CSV</h1>
  <div class="card">
    <div class="row">
      <div class="col">
        <label for="file">Container export (container.json)</label>
        <input id="file" type="file" accept=".json,application/json" />
        <div class="help">Export from GTM Admin → Export Container (JSON).</div>
      </div>
      <div class="col">
        <label>Include entities</label>
        <div class="opts">
          <label class="opt"><input type="checkbox" id="incTags" checked /> Tags</label>
          <label class="opt"><input type="checkbox" id="incTriggers" checked /> Triggers</label>
          <label class="opt"><input type="checkbox" id="incVars" checked /> Variables</label>
        </div>
        <label>Options</label>
        <div class="opts">
          <label class="opt"><input type="checkbox" id="includeTagContent" /> Include tag content column</label>
          <label class="opt"><input type="checkbox" id="oneHotTriggers" /> Expand firing/blocking triggers to columns</label>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="col">
        <button id="toExcel" disabled>Export Excel (.xlsx)</button>
        <button id="toCsv" class="secondary" disabled>Export CSVs</button>
      </div>
    </div>

    <div style="margin-top:16px;">
      <label>Log</label>
      <div id="log" class="log">Waiting for file…</div>
    </div>
  </div>

<script>
  const logEl = document.getElementById('log');
  const fileEl = document.getElementById('file');
  const toExcelBtn = document.getElementById('toExcel');
  const toCsvBtn = document.getElementById('toCsv');
  const incTagsEl = document.getElementById('incTags');
  const incTriggersEl = document.getElementById('incTriggers');
  const incVarsEl = document.getElementById('incVars');
  const includeTagContentEl = document.getElementById('includeTagContent');
  const oneHotTriggersEl = document.getElementById('oneHotTriggers');

  let gtm = null;

  function log(msg){ logEl.textContent += "\\n" + msg; }
  function reset(){ gtm=null; toExcelBtn.disabled=true; toCsvBtn.disabled=true; logEl.textContent="Waiting for file…"; }

  fileEl.addEventListener('change', async (e) => {
    reset();
    const file = e.target.files?.[0]; if(!file) return;
    log('Reading ' + file.name + ' …');
    try {
      const text = await file.text();
      const json = JSON.parse(text);
      gtm = (json?.containerVersion || json?.exportFormatVersion) ? normalizeGtm(json) : normalizeEntities(json);
      summarize(gtm);
      toExcelBtn.disabled=false; toCsvBtn.disabled=false; log('Ready to export.');
    } catch(err){ log('ERROR: ' + err.message); }
  });

  function normalizeGtm(json){
    const cv = json.containerVersion || json;
    return {
      accountId: cv.accountId || json.accountId || '',
      containerId: cv.containerId || json.containerId || '',
      container: json.container || null,
      tags: cv.tag || [],
      triggers: cv.trigger || [],
      variables: cv.variable || [],
      folders: cv.folder || [],
      builtInVars: cv.builtInVariable || [],
      exportFormatVersion: json.exportFormatVersion || null,
      versionName: cv.name || json.name || '',
    };
  }
  function normalizeEntities(json){
    return {
      accountId: '', containerId: '',
      tags: json.tag || json.tags || [],
      triggers: json.trigger || json.triggers || [],
      variables: json.variable || json.variables || [],
      folders: json.folder || [],
      builtInVars: json.builtInVariable || [],
      exportFormatVersion: json.exportFormatVersion || null,
      versionName: json.name || '',
    };
  }
  function summarize(gtm){
    log('Container summary:');
    log('Tags: ' + (gtm.tags?.length||0));
    log('Triggers: ' + (gtm.triggers?.length||0));
    log('Variables: ' + (gtm.variables?.length||0));
  }

  function paramVal(p){
    if(!p) return '';
    if('value' in p) return p.value;
    if(Array.isArray(p.list)) return p.list.map(paramVal).join(', ');
    if(Array.isArray(p.map)){
      const obj={}; for(const entry of p.map){ obj[entry.key]=paramVal(entry.value||entry); }
      return JSON.stringify(obj);
    }
    if(typeof p==='object') return JSON.stringify(p);
    return String(p);
  }
  function flattenParameters(parameters){
    const out={}; if(!Array.isArray(parameters)) return out;
    for(const p of parameters){ const key=p.key || '(no key)'; out[key]=paramVal(p); }
    return out;
  }
  function idToNameMap(triggers){
    const map={}; for(const t of triggers||[]){ if(t.triggerId) map[t.triggerId]= t.name || ('Trigger '+t.triggerId); }
    return map;
  }
  function mapIdArrayToNames(ids, map){ if(!Array.isArray(ids)) return ''; return ids.map(id => map[id] || id).join(', '); }

  function buildTagsSheet(gtm, opts){
    const trigMap = idToNameMap(gtm.triggers);
    const rows = [];
    for(const tag of gtm.tags||[]){
      const base = {
        tagId: tag.tagId||'', name: tag.name||'', type: tag.type||'',
        liveOnly: tag.liveOnly ?? '', priority: tag.priority?.value ?? '',
        notes: tag.notes || '', consentType: tag.consentSettings?.consentType || '',
        firingTriggers: mapIdArrayToNames(tag.firingTriggerId, trigMap),
        blockingTriggers: mapIdArrayToNames(tag.blockingTriggerId, trigMap),
        folderId: tag.parentFolderId || '',
      };
      const params = flattenParameters(tag.parameter);
      const row = { ...base, ...params };
      if(opts.includeTagContent) row.tagContent = JSON.stringify(tag, null, 2);
      rows.push(row);
    }
    if(opts.oneHotTriggers){
      const all = new Set();
      for(const r of rows){
        for(const n of (r.firingTriggers||'').split(', ').filter(Boolean)) all.add('fires:'+n);
        for(const n of (r.blockingTriggers||'').split(', ').filter(Boolean)) all.add('blocks:'+n);
      }
      const cols = Array.from(all);
      for(const r of rows){
        for(const c of cols){
          const [k,n] = c.split(':',2);
          const list = k==='fires' ? (r.firingTriggers||'') : (r.blockingTriggers||'');
          r[c] = list.split(', ').includes(n) ? 1 : 0;
        }
      }
    }
    return rows;
  }

  function buildTriggersSheet(gtm){
    const rows=[];
    for(const tr of gtm.triggers||[]){
      rows.push({
        triggerId: tr.triggerId||'', name: tr.name||'', type: tr.type||'',
        filters: Array.isArray(tr.filter) ? tr.filter.map(f=>JSON.stringify(f)).join(' | ') : '',
        parameters: JSON.stringify(flattenParameters(tr.parameter||[])),
        notes: tr.notes||'', folderId: tr.parentFolderId||'',
      });
    }
    return rows;
  }

  function buildVariablesSheet(gtm){
    const rows=[];
    for(const v of gtm.variables||[]){
      const base = { variableId: v.variableId||'', name: v.name||'', type: v.type||'', notes: v.notes||'', folderId: v.parentFolderId||'' };
      const params = flattenParameters(v.parameter);
      rows.push({ ...base, ...params });
    }
    return rows;
  }

  function toSheet(rows){ return XLSX.utils.json_to_sheet(rows); }

  function downloadXlsx(gtm, opts){
    const wb = XLSX.utils.book_new();
    if(document.getElementById('incTags').checked) XLSX.utils.book_append_sheet(wb, toSheet(buildTagsSheet(gtm, opts)), 'Tags');
    if(document.getElementById('incTriggers').checked) XLSX.utils.book_append_sheet(wb, toSheet(buildTriggersSheet(gtm)), 'Triggers');
    if(document.getElementById('incVars').checked) XLSX.utils.book_append_sheet(wb, toSheet(buildVariablesSheet(gtm)), 'Variables');
    const name = (gtm.container?.name || 'gtm_export') + '.xlsx';
    XLSX.writeFile(wb, name);
  }

  function downloadCsvs(gtm, opts){
    const prefix = (gtm.container?.name || 'gtm_export');
    function save(name, rows){
      const ws = toSheet(rows);
      const csv = XLSX.utils.sheet_to_csv(ws);
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }
    if(document.getElementById('incTags').checked) save(prefix+'_Tags.csv', buildTagsSheet(gtm, opts));
    if(document.getElementById('incTriggers').checked) save(prefix+'_Triggers.csv', buildTriggersSheet(gtm));
    if(document.getElementById('incVars').checked) save(prefix+'_Variables.csv', buildVariablesSheet(gtm));
  }

  document.getElementById('toExcel').addEventListener('click', ()=>{
    downloadXlsx(gtm, { includeTagContent: includeTagContentEl.checked, oneHotTriggers: oneHotTriggersEl.checked });
  });
  document.getElementById('toCsv').addEventListener('click', ()=>{
    downloadCsvs(gtm, { includeTagContent: includeTagContentEl.checked, oneHotTriggers: oneHotTriggersEl.checked });
  });

  // GitHub Pages quirk handling: ensure user gesture before download
  document.addEventListener('click', ()=>{ /* establishes a user gesture for download APIs */ }, {once:true});
</script>
</body>
</html>
